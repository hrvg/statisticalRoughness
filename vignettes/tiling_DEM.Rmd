---
title: "Tiling DEM"
author:
- name: HervÃ© Guillon
  affiliation: University of California, Davis
date: "`r format(Sys.time(), '%d %B %Y')`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Tiling DEM}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```
library("terra")
library("tictoc")
library("statisticalRoughness")

# run time ~ 40 minutes

gc()
root.dir <- get_rootdir()

Lmax <- 1E4
allLR <- get_all_R_L(Lmax, 5, only = 12, len = 32)
maxL <- max(allLR$allL)

dem.dir <- 'data/california-rivers/gis-files/NED'

terraOptions(tempdir = file.path(root.dir, dem.dir), memfrac = 0.7)

fname <- "CA_DEM.grd"
fname_sans_ext <- tools::file_path_sans_ext(fname)
DEM <- terra::rast(file.path(root.dir, dem.dir, fname))

if(!file.exists(file.path(root.dir, dem.dir, paste0(fname_sans_ext, "_Lmax-resampled.tif")))){
	tic()
	print("Resampling raster...")
	maxL_raster <- aggregate(DEM, fact = maxL, fun = mean)
	toc()

	print("Writing raster...")
	writeRaster(maxL_raster, file.path(root.dir, dem.dir, paste0(fname_sans_ext, "_Lmax-resampled.tif")), overwrite = TRUE)

	print("Raster to polygons...")
	maxL_raster <- raster::raster(file.path(root.dir, dem.dir, paste0(fname_sans_ext, "_Lmax-resampled.tif")))
	maxL_polygons <- raster::rasterToPolygons(maxL_raster)
	# maxL_polygons <- terra:as.polygons(maxL_raster, dissolve = FALSE, values = FALSE)

	print("Writing polygons...")
	raster::shapefile(maxL_polygons, file.path(root.dir, dem.dir, paste0(fname_sans_ext, "_Lmax-polygons.shp")), overwrite = TRUE)
} else {
	print("Reading polygons...")
	maxL_polygons <- vect(file.path(root.dir, dem.dir, paste0(fname_sans_ext, "_Lmax-polygons.shp")))
}

print("Tiling DEM...")
out.dir <- file.path(root.dir, dem.dir, paste0(fname_sans_ext, "_tiles"))
if (!dir.exists(out.dir)) dir.create(out.dir)
for (n in seq(1, length(maxL_polygons))){
	print(n)
	fname <- file.path(out.dir, paste0(fname_sans_ext, "_tile_", n, ".tif"))
	dem <- crop(DEM, maxL_polygons[n, ])
	terra::writeRaster(dem, fname, overwrite = TRUE)
}

tmpFiles(old = TRUE, remove = TRUE)
raster::removeTmpFiles(h = 0)
```